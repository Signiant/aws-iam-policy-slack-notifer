{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Metadata":{
      "AWS::CloudFormation::Interface":{
         "ParameterGroups":[
            {
               "Label":{
                  "default":"Function Code Location"
               },
               "Parameters":[
                  "FunctionS3Bucket",
                  "FunctionS3Key"
               ]
            },
            {
               "Label":{
                  "default":"Slack Configuration"
               },
               "Parameters":[
                  "SlackApiKey",
                  "SlackChannel"
               ]
            }
         ]
      }
   },
   "Parameters":{
      "FunctionS3Bucket":{
         "Type":"String",
         "Default":"",
         "Description":"S3 bucket containing the Lambda function zip file"
      },
      "FunctionS3Key":{
         "Type":"String",
         "Default":"",
         "Description":"S3 key within the bucket for the function (ie. folder/foo.zip)"
      },
      "SlackApiKey":{
         "Type":"String",
         "Default":"",
         "Description":"Valid Slack API Key (obtain by creating a bot)"
      },
      "SlackChannel":{
         "Type":"String",
         "Default":"#general",
         "Description":"Slack Channel to post scaling notifications to"
      }
   },
   "Resources":{
      "FunctionRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "Path":"/iam/",
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Policies":[
               {
                  "PolicyName":"IAMPolicyNotifier",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Sid":"Logging",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Effect":"Allow",
                           "Resource":"arn:aws:logs:*:*:*:*"
                        },
                        {
                          "Sid":"IAM",
                          "Action":[
                             "iam:Describe*"
                          ],
                          "Effect":"Allow",
                          "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "NotifySlackFunction":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "FunctionName":"IAMSlackNotifier",
            "Description":"Notify in Slack when IAM security changes occur",
            "Role":{
               "Fn::GetAtt":[
                  "FunctionRole",
                  "Arn"
               ]
            },
            "Runtime":"python3.8",
            "Handler":"iam-notify-slack.lambda_handler",
            "MemorySize":128,
            "Timeout":20,
            "Environment":{
               "Variables":{
                  "slack_api_token":{
                     "Ref":"SlackApiKey"
                  },
                  "slack_channel":{
                     "Ref":"SlackChannel"
                  }
               }
            },
            "Code":{
               "S3Bucket":{
                  "Ref":"FunctionS3Bucket"
               },
               "S3Key":{
                  "Ref":"FunctionS3Key"
               }
            }
         }
      },
      "IAMChangeRule":{
         "Type":"AWS::Events::Rule",
         "Properties":{
            "Description":"Triggered when certain IAM events occur",
            "Name":"IAMSecurityChangesEvent",
            "State":"ENABLED",
            "EventPattern":{
              "source": [
                "aws.iam"
              ],
              "detail-type": [
                "AWS API Call via CloudTrail"
              ],
              "detail": {
                "eventSource": [
                  "iam.amazonaws.com"
                ],
                "eventName": [
                  "CreatePolicy",
                  "CreatePolicyVersion",
                  "AttachUserPolicy",
                  "DetachUserPolicy",
                  "AttachRolePolicy",
                  "DetachRolePolicy",
                  "AttachGroupPolicy",
                  "DetachGroupPolicy"
                ]
              }
            },
            "Targets":[
               {
                  "Arn":{
                     "Fn::GetAtt":[
                        "NotifySlackFunction",
                        "Arn"
                     ]
                  },
                  "Id":"IAMNotifySlackFunction"
               }
            ]
         }
      },
      "LambdaInvokePermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:InvokeFunction",
            "FunctionName":{
               "Fn::GetAtt":[
                  "NotifySlackFunction",
                  "Arn"
               ]
            },
            "Principal":"events.amazonaws.com",
            "SourceArn":{
               "Fn::GetAtt":[
                  "IAMChangeRule",
                  "Arn"
               ]
            }
         }
      }
   }
}
